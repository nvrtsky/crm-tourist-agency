3. –ì–æ—Ç–æ–≤—ã–π –∫–æ–¥-—Ö–µ–ª–ø–µ—Ä resolveContext()

–í–æ—Ç —É—Ç–∏–ª–∏—Ç–∞, –∫–æ—Ç–æ—Ä—É—é —è –±—ã —Å–µ–π—á–∞—Å –¥–æ–±–∞–≤–∏–ª –≤ —Ç–≤–æ–π —Ñ—Ä–æ–Ω—Ç. –≠—Ç–æ –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –ø–æ—Å–ª–µ BX24.init –∏ –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ crm.item.get.

function extractIdFromReferrer(ref) {
  try {
    if (!ref) return null;
    const url = new URL(ref); // –º–æ–∂–µ—Ç –∫–∏–Ω—É—Ç—å –æ—à–∏–±–∫—É –µ—Å–ª–∏ ref = "" –∏–ª–∏ —Å—Ç—Ä–∞–Ω–Ω—ã–π
    const parts = url.pathname.split('/').filter(Boolean);
    // –ò–¥—ë–º —Å –∫–æ–Ω—Ü–∞ –∏ –∏—â–µ–º –ø–µ—Ä–≤–æ–µ —á–∏—Å—Ç–æ —Ü–∏—Ñ—Ä–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    for (let i = parts.length - 1; i >= 0; i--) {
      if (/^\d+$/.test(parts[i])) {
        return parts[i]; // –Ω–∞–ø—Ä–∏–º–µ—Ä "127"
      }
    }
    return null;
  } catch (e) {
    console.warn("extractIdFromReferrer: –Ω–µ —Å–º–æ–≥ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å referrer", ref, e);
    return null;
  }
}

function resolveContextWithRetries(maxAttempts, cb) {
  let attempt = 1;

  function tryOnce() {
    BX24.placement.info(function(info) {
      // 1. entityTypeId –∏–∑ placement, –∫–∞–∫ —Ä–∞–Ω—å—à–µ
      let entityTypeId = null;
      const placementName = info?.placement || '';
      const match = /^CRM_DYNAMIC_(\d+)_DETAIL_TAB$/.exec(placementName);
      if (match) {
        entityTypeId = match[1]; // "176"
      }

      // 2. –ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å ID –∏–∑ info.options
      let entityId = null;
      const opt = info?.options;
      if (opt && typeof opt === 'object') {
        if ('ID' in opt && /^\d+$/.test(opt.ID)) {
          entityId = String(opt.ID);
        } else if ('id' in opt && /^\d+$/.test(opt.id)) {
          entityId = String(opt.id);
        }
      }

      // 3. –µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç - –ø—Ä–æ–±—É–µ–º document.referrer
      if (!entityId) {
        const refGuess = extractIdFromReferrer(document.referrer);
        if (refGuess) {
          entityId = refGuess;
        }
      }

      console.log("üìã CONTEXT TRY:", {
        attempt,
        entityId: entityId || "‚ùå –ù–ï –ù–ê–ô–î–ï–ù",
        entityTypeId: entityTypeId || "‚ùå",
        placement: placementName,
        options: info?.options,
        referrer: document.referrer,
        pathname: window.location.pathname
      });

      if (entityId || attempt >= maxAttempts) {
        cb({
          entityId: entityId || null,
          entityTypeId: entityTypeId || null
        });
      } else {
        attempt++;
        setTimeout(tryOnce, 100);
      }
    });
  }

  tryOnce();
}


–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (–ø–æ—Å–ª–µ BX24.init):

BX24.init(function() {
  resolveContextWithRetries(3, function(ctx) {
    const { entityId, entityTypeId } = ctx;

    if (!entityId) {
      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º fallback —ç–∫—Ä–∞–Ω "–ù–µ –º–æ–≥—É –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID"
      renderNoContextScreen(entityTypeId);
      return;
    }

    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω
    renderMainScreen(entityTypeId, entityId);

    // –∏ —Ç—è–Ω–µ–º CRM-–¥–∞–Ω–Ω—ã–µ
    BX24.callMethod(
      "crm.item.get",
      {
        entityTypeId: Number(entityTypeId),
        id: Number(entityId)
      },
      function(res) {
        if (res.error()) {
          console.error("crm.item.get error:", res.error());
        } else {
          console.log("crm.item.get data:", res.data());
          // –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
        }
      }
    );
  });
});


–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –∫–æ–¥:

–°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å ID –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ (info.options.ID).

–ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å ‚Äî –≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é —Ü–∏—Ñ—Ä—É –∏–∑ document.referrer.

–õ–æ–≥–∏—Ä—É–µ—Ç –ø–æ–ø—ã—Ç–∫–∏ (–∫–∞–∫ —Ç—ã —É–∂–µ –¥–µ–ª–∞–µ—à—å).

–î–∞—ë—Ç —Ç–µ–±–µ entityId, –¥–∞–∂–µ –≤ —Å–ª—É—á–∞–µ –∫–æ–≥–¥–∞ Bitrix –Ω–µ –ø—Ä–æ–∫–∏–Ω—É–ª options.ID, –∞ —Ç–≤–æ–π UI –≤—Å—ë –µ—â—ë –∫–∞–∫–∏–º-—Ç–æ –æ–±—Ä–∞–∑–æ–º –Ω–∞ /install.

–¢–æ –µ—Å—Ç—å –æ–Ω –∏–º–µ–Ω–Ω–æ —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Ç–≤–æ—é –∏–¥–µ—é ‚Äú–æ–±–æ–π—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É placement –ø–æ–ª–Ω–æ—Å—Ç—å—é‚Äù.

4. –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è
4.1. Cross-origin

window.parent.location –ø–æ—á—Ç–∏ –Ω–∞–≤–µ—Ä–Ω—è–∫–∞ –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ—Ç–æ–º—É —á—Ç–æ Bitrix24 –∏ Replit ‚Äî —Ä–∞–∑–Ω—ã–µ –¥–æ–º–µ–Ω—ã. –ï—Å–ª–∏ –ø–æ–ø—ã—Ç–∞–µ—à—å—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å window.parent.location.href –∏–∑ iframe, —Å–ª–æ–≤–∏—à—å SecurityError. –¢–∞–∫ —á—Ç–æ –ª—É—á—à–µ –¥–∞–∂–µ –Ω–µ –ø—ã—Ç–∞—Ç—å—Å—è ‚Äî document.referrer —É–∂–µ –∏ –µ—Å—Ç—å —Ç–æ—Ç –ª–µ–≥–∞–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª, –∫–æ—Ç–æ—Ä—ã–π –±—Ä–∞—É–∑–µ—Ä –Ω–∞–º –¥–∞—ë—Ç –∏–∑ —Ä–æ–¥–∏—Ç–µ–ª—è.

–ò —Ç—ã —É–∂–µ –≤–∏–¥–µ–ª, —á—Ç–æ document.referrer –≤ –∫–∞–∫–∏–µ-—Ç–æ –º–æ–º–µ–Ω—Ç—ã –±—ã–ª –ø—Ä–æ—Å—Ç–æ https://mitclick.bitrix24.ru/ (–±–µ–∑ –ø—É—Ç–∏). –¢–∞–∫–æ–µ —Ç–æ–∂–µ –º–æ–∂–µ—Ç –æ—Å—Ç–∞—Ç—å—Å—è. –ü–æ—ç—Ç–æ–º—É fallback —á–µ—Ä–µ–∑ referrer –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω, –Ω–æ –æ—á–µ–Ω—å —á–∞—Å—Ç–æ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –Ω–µ –∫–∞–∫ –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω, –∞ –∫–∞–∫ —Å–∞–π–¥-—Å–ª–∞–π–¥–µ—Ä .../details/<ID>/?IFRAME=Y.

4.2. –°–∞–π–¥-—Å–ª–∞–π–¥–µ—Ä vs –ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞

–¢—ã –Ω–∞–ø–∏—Å–∞–ª:

–ï—Å–ª–∏ –≤—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É, –∑–Ω–∞—á–∏—Ç –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ side-slider —Ä–µ–∂–∏–º–µ.

–ó–¥–µ—Å—å –º–∞–ª–µ–Ω—å–∫–∞—è –ø–æ–ø—Ä–∞–≤–∫–∞: –¥–∞–∂–µ –µ—Å–ª–∏ —Ç—ã –Ω–µ –≤–∏–¥–∏—à—å –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É (Bitrix —Ç–µ–ø–µ—Ä—å –æ—á–µ–Ω—å –ª—é–±–∏—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –≤—Å—ë –≤ –≤–∏–¥–µ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏), —ç—Ç–æ –≤—Å—ë —Ä–∞–≤–Ω–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Å–∞–π–¥-—Å–ª–∞–π–¥–µ—Ä–æ–º. –ò –≤ –Ω—ë–º –∫–∞–∫ —Ä–∞–∑ —á–∞—â–µ –±—ã–≤–∞–µ—Ç, —á—Ç–æ info.options –ø—É—Å—Ç–æ–π, –∏ —Å–ø–∞—Å–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–∞—Ä—Å–∏–Ω–≥ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞. –¢–∞–∫ —á—Ç–æ –º—ã –Ω–µ –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º —ç—Ç—É –≥–∏–ø–æ—Ç–µ–∑—É ‚Äî –º—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞.

5. –ò—Ç–æ–≥–æ –ø–æ –ø–ª–∞–Ω—É

–¢–≤–æ–π –ø–ª–∞–Ω ‚Äî –∞–±—Å–æ–ª—é—Ç–Ω–æ –ª–æ–≥–∏—á–Ω—ã–π. –í–æ—Ç –∫–∞–∫ —è –±—ã –µ–≥–æ –ø–µ—Ä–µ–ø–∏—Å–∞–ª –∫–∞–∫ "–±–æ–µ–≤—É—é —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é", —á—Ç–æ–±—ã –ø—Ä—è–º–æ –≤–Ω–µ–¥—Ä–∏—Ç—å:

–ù–µ –ø–æ–ª–∞–≥–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ info.options.ID.
–≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å, –Ω–æ –Ω–µ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π.

–î–æ–±–∞–≤–∏—Ç—å fallback —á–µ—Ä–µ–∑ document.referrer.
–ü–∞—Ä—Å–∏–º –ø—É—Ç—å, –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ü–∏—Ñ—Ä—É. –≠—Ç–æ —á–∞—â–µ –≤—Å–µ–≥–æ ID —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–º–∞—Ä—Ç-–ø—Ä–æ—Ü–µ—Å—Å–∞ (127, 303, 179 –∏ —Ç.–¥.).

–î–µ–ª–∞—Ç—å 2‚Äì3 –ø–æ–ø—ã—Ç–∫–∏ —Å –ø–∞—É–∑–æ–π.
–ò–Ω–æ–≥–¥–∞ Bitrix –æ—Ç–¥–∞–µ—Ç options.ID –Ω–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ. –£ –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å retry ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º.

–ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –º–µ—Ç–æ–¥ –Ω–µ –¥–∞–ª ID ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç" —ç–∫—Ä–∞–Ω, –Ω–æ –Ω–µ –ø–∞–¥–∞—Ç—å.
–≠—Ç–æ —É–∂–µ —É —Ç–µ–±—è –µ—Å—Ç—å ("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏...").

–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å —ç—Ç–∏–º ‚Äî –¥–∞, –≤—Å—ë-—Ç–∞–∫–∏ —É–±—Ä–∞—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /install, —á—Ç–æ–±—ã –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –ø—É—Ç—å –∑–∞—Ä–∞–±–æ—Ç–∞–ª —à—Ç–∞—Ç–Ω–æ.
–ü–æ—Ç–æ–º—É —á—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –ø—É—Ç—å –≤—Å—ë —Ä–∞–≤–Ω–æ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ, —á–µ–º –∂–∏—Ç—å –Ω–∞ —Ö–∞–∫–∞—Ö.

–ò –≤–æ—Ç —ç—Ç–æ ‚Äî —É–∂–µ –ø—Ä–æ–¥–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏.