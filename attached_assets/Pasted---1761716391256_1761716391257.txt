–¢—ã –º—ã—Å–ª–∏—à—å –∫–∞–∫ –±–æ–µ—Ü –ø–æ–ª–µ–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è üëç –≠—Ç–æ —É–∂–µ –∏–Ω–∂–µ–Ω–µ—Ä–∏—è, –∞ –Ω–µ "–ø—Ä–æ—Å—Ç–æ –ø–æ–¥–∫–ª—é—á–∏–ª–∏". –Ø –æ—á–µ–Ω—å —Ä–∞–¥, —á—Ç–æ —Ç—ã —Å–∞–º –Ω–∞—á–∞–ª –¥—É–º–∞—Ç—å –ø—Ä–æ –∞–≤–∞—Ä–∏–π–Ω—ã–µ –∫–∞–Ω–∞–ª—ã (fallback extraction). –Ø —Å–µ–π—á–∞—Å –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Ä–∞–∑–±–µ—Ä—É —Ç–≤–æ–π –ø–ª–∞–Ω, –ø–æ–∫–∞–∂—É –≥–¥–µ –æ–Ω –∂–µ–ª–µ–∑–Ω—ã–π, –≥–¥–µ –µ—Å—Ç—å —Å–∫—Ä—ã—Ç—ã–µ –≥—Ä–∞–±–ª–∏, –∏ –¥–∞–º –≥–æ—Ç–æ–≤—ã–π –∫–æ–¥ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏.

–°–ø–æ–π–ª–µ—Ä: –¥–∞, –º—ã –º–æ–∂–µ–º –¥–æ—Å—Ç–∞—Ç—å ID –¥–∞–∂–µ –µ—Å–ª–∏ Bitrix –Ω–µ –¥–∞—ë—Ç options.ID. –ù–æ –µ—Å—Ç—å –û–ß–ï–ù–¨ –≤–∞–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ ‚Äî –¥–æ—Å—Ç—É–ø –∫ window.parent.location.

–ü–æ–µ—Ö–∞–ª–∏.

0. –ú–∞–ª–µ–Ω—å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–∏–ø–æ—Ç–µ–∑—ã –ø—Ä–æ –∫—ç—à

–¢—ã —Å–∫–∞–∑–∞–ª:

–º–æ–∂–µ—Ç –±—ã—Ç—å, placement.bind –¥–∞–ª 400 –∏ —Ä–µ–∞–ª—å–Ω–æ –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è

–ú—ã —É–∂–µ —Å–¥–µ–ª–∞–ª–∏ placement.get –∏ –ø–æ–ª—É—á–∏–ª–∏:

{
  placement: 'CRM_DYNAMIC_176_DETAIL_TAB',
  handler: 'https://travel-group-manager-ndt72.replit.app/',
  title: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–æ–π',
  ...
}


–¢–æ –µ—Å—Ç—å –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ø–æ—Ä—Ç–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ '/', –Ω–µ /install. –ó–Ω–∞—á–∏—Ç Bitrix24 —Å—á–∏—Ç–∞–µ—Ç, —á—Ç–æ –≤–∫–ª–∞–¥–∫–∞ = /.

–ü–æ—á–µ–º—É –∂–µ –º—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –≤–∏–¥–∏–º pathname: '/install' –≤–Ω—É—Ç—Ä–∏ iframe?
–ï—Å—Ç—å —Ä–æ–≤–Ω–æ 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞:

–õ–∏–±–æ —Ç–≤–æ–π –∫–æ–¥/—Ä–æ—É—Ç–µ—Ä –≤–Ω—É—Ç—Ä–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å–∞–º —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç —Å / –Ω–∞ /install.
–≠—Ç–æ —Å–∞–º—ã–π —á–∞—Å—Ç—ã–π –∫–µ–π—Å –∏ –ø–æ–∫–∞ —á—Ç–æ –Ω–∞—à –≥–ª–∞–≤–Ω—ã–π –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º—ã–π.

–õ–∏–±–æ —Ç–≤–æ–π –±–∏–ª–¥ –Ω–∞ / —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –æ—Ç–¥–∞–µ—Ç —Ç–æ—Ç –∂–µ HTML, –∫–æ—Ç–æ—Ä—ã–π —Å–∞–º —Å—Ä–∞–∑—É –º–µ–Ω—è–µ—Ç window.location –Ω–∞ /install.
–≠—Ç–æ —Ç–æ—Ç –∂–µ —Å—Ü–µ–Ω–∞—Ä–∏–π, —Ç–æ–ª—å–∫–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ —Å—Ç–∞—Ç–∏–∫—É.

–ù–æ —è —Å–æ–≥–ª–∞—à—É—Å—å —Å —Ç–≤–æ–∏–º –∏–Ω—Å—Ç–∏–Ω–∫—Ç–æ–º: –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ —Ç–∞–∫, –¥–∞–≤–∞–π —Å–¥–µ–ª–∞–µ–º ¬´–≥—Ä—è–∑–æ–∑–∞—â–∏—Ç—É¬ª ‚Äî —á—Ç–æ–±—ã –º—ã —É–º–µ–ª–∏ –¥–æ–±—ã—Ç—å entityId –¥–∞–∂–µ –≤ —Ö—É–¥—à–µ–º —Å–ª—É—á–∞–µ.

–≠—Ç–æ –æ—á–µ–Ω—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ, —Ç–∞–∫ —Ä–µ–∞–ª—å–Ω–æ –¥–µ–ª–∞—é—Ç –≤ –ø—Ä–æ–¥–µ: –≤—Å–µ–≥–¥–∞ –∏–º–µ—Ç—å fallback.

1. –ß—Ç–æ —Ç—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å —Å–¥–µ–ª–∞—Ç—å

–¢—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å —Ç—Ä–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø—Ä–∞–≤–¥—ã:

BX24.placement.info() ‚Üí info.options.ID
–≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—É—Ç—å (–∏–¥–µ–∞–ª—å–Ω—ã–π). –ò–Ω–æ–≥–¥–∞ –ø—É—Å—Ç–æ–π.

–ü–∞—Ä—Å document.referrer
–ü—Ä–∏–º–µ—Ä –æ–∂–∏–¥–∞–µ–º–æ–≥–æ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞:

https://mitclick.bitrix24.ru/crm/type/176/details/303/?IFRAME=Y...
–ò–∑ —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ –≤—ã—Ç–∞—â–∏—Ç—å 303.

–ü–∞—Ä—Å –≤–Ω–µ—à–Ω–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤–∏–¥–∞ 127/?IFRAME=Y&...
–¢—ã —ç—Ç–æ —É–∂–µ –≤–∏–¥–µ–ª –≤ —Å—Ç–µ–∫–µ:
at 127/?IFRAME=Y&IFRAME_TYPE=SIDE_SLIDER:1398.
–ó–¥–µ—Å—å 127 ‚Äî —Ç–æ—Ç —Å–∞–º—ã–π ID —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–º–∞—Ä—Ç-–ø—Ä–æ—Ü–µ—Å—Å–∞.

–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å window.parent.location
–ò–¥–µ—è –ø–æ–Ω—è—Ç–Ω–∞—è: "–µ—Å–ª–∏ –º—ã –≤ iframe –Ω–∞ –¥–æ–º–µ–Ω–µ replit.app, –∞ —Ä–æ–¥–∏—Ç–µ–ª—å ‚Äî mitclick.bitrix24.ru, –º–æ–∂–Ω–æ –≤–∑—è—Ç—å URL —Ä–æ–¥–∏—Ç–µ–ª—è".

üíî –ù–æ —Ç—É—Ç –±—É–¥–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –ø–æ–ª–∏—Ç–∏–∫–∞ –±—Ä–∞—É–∑–µ—Ä–∞ Same-Origin Policy.
–ï—Å–ª–∏ –¥–æ–º–µ–Ω—ã —Ä–∞–∑–Ω—ã–µ (mitclick.bitrix24.ru ‚â† travel-group-manager-ndt72.replit.app), –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ window.parent.location –∏–∑ iframe –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –≠—Ç–æ –ø–æ—á—Ç–∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Ç–∞–∫. –í –±–æ—é —Ç—ã –ø–æ–ª—É—á–∏—à—å DOMException: Blocked a frame from accessing a cross-origin frame.

‚Üí –¢–æ –µ—Å—Ç—å window.parent.location –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ–ª—å–∑—è. –ú—ã –Ω–µ –º–æ–∂–µ–º –Ω–∞–¥–µ–∂–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å –Ω–∞ —ç—Ç–æ –∫–∞–∫ –Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫.

–ù–æ! –ï—Å—Ç—å –ø—Ä–∏—è—Ç–Ω—ã–π –º–æ–º–µ–Ω—Ç: document.referrer –∫–∞–∫ —Ä–∞–∑ –∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –¥–ª—è —ç—Ç–æ–≥–æ ‚Äî —ç—Ç–æ —Ç–æ, —á—Ç–æ –±—Ä–∞—É–∑–µ—Ä –¥–∞—ë—Ç iframe-—Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã —Ä–æ–¥–∏—Ç–µ–ª—è, –¥–∞–∂–µ –ø—Ä–∏ cross-origin. –¢–æ –µ—Å—Ç—å —É –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å –∏–º–µ–Ω–Ω–æ –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤–µ—Ä—Å–∏—è window.parent.location.href: —ç—Ç–æ –∏ –µ—Å—Ç—å document.referrer.

–ò—Ç–æ–≥–æ:

window.parent.location ‚Äî –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.

document.referrer ‚Äî –∫–∞–∫ —Ä–∞–∑ –ø–æ–¥—Ö–æ–¥–∏—Ç –∏ –∑–∞–∫–æ–Ω–Ω–æ –¥–æ—Å—Ç—É–ø–µ–Ω.

–ó–Ω–∞—á–∏—Ç —Ç–≤–æ–π —à–∞–≥ "–∏–ª–∏ –∏–∑ parent" –º—ã –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ "—á–µ—Ä–µ–∑ document.referrer". –≠—Ç–æ –æ–∫.

2. –ö–∞–∫ –±—É–¥–µ–º –∏–∑–≤–ª–µ–∫–∞—Ç—å entityId –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º

–ü—Ä—è–º–æ –ø—Ä–æ–¥-—Å—Ç—Ä–∞—Ç–µ–≥–∏—è:

–®–∞–≥ 1. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–±
BX24.placement.info(...)
‚Üí info.options.ID


–ï—Å–ª–∏ –µ—Å—Ç—å ‚Äî —Å—É–ø–µ—Ä, –≤—Å—ë, –≤—ã—Ö–æ–¥–∏–º.

–®–∞–≥ 2. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∏–∑ document.referrer

–ü—Ä–∏–º–µ—Ä—ã —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —É–∂–µ –≤–∏–¥–µ–ª–∏ –∏–ª–∏ –æ–∂–∏–¥–∞–µ–º:

https://mitclick.bitrix24.ru/crm/type/176/details/127/?IFRAME=Y&IFRAME_TYPE=SIDE_SLIDER

–∏–ª–∏ —É—Ä–µ–∑–∞–Ω–Ω—ã–π https://mitclick.bitrix24.ru/ (–≥—Ä—É—Å—Ç–Ω–æ, –Ω–æ –±—ã–≤–∞–µ—Ç)

–ö–∞–∫ –º—ã –±—É–¥–µ–º –≤—ã—Ç–∞—Å–∫–∏–≤–∞—Ç—å:

–ë–µ—Ä—ë–º new URL(document.referrer).pathname

–î–µ–ª–∞–µ–º split –ø–æ /

–ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∏—Å–ª–æ–≤–æ–π —Å–µ–≥–º–µ–Ω—Ç

–ü—Ä–∏–º–µ—Ä:

/crm/type/176/details/127/  ‚Üí ["crm","type","176","details","127"]
–ø–æ—Å–ª–µ–¥–Ω—è—è —Ü–∏—Ñ—Ä–∞ = 127

–®–∞–≥ 3. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤—ã–∫–æ–≤—ã—Ä—è—Ç—å ID –∏–∑ —Å—Ç–µ–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ iframe URL

–ò–Ω–æ–≥–¥–∞ —Å–∞–º iframe –≥—Ä—É–∑–∏—Ç—Å—è –ø–æ URL, –≤ –∫–æ—Ç–æ—Ä–æ–º –ø—É—Ç—å –≤—ã–≥–ª—è–¥–∏—Ç –≤–æ—Ç —Ç–∞–∫:
https://...replit.app/install?DOMAIN=...&APP_SID=...
–¢–∞–º ID —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ—Ç.

–ù–æ –º—ã —Ç–∞–∫–∂–µ –≤–∏–¥–µ–ª–∏ –≤ —Å—Ç–µ–∫–µ Bitrix —á—Ç–æ iframe –ø–æ–¥—Å–æ–≤—ã–≤–∞—é—Ç –≤ –¥–æ–∫—É–º–µ–Ω—Ç —Ç–∏–ø–∞:
127/?IFRAME=Y&IFRAME_TYPE=SIDE_SLIDER:1398
–≠—Ç–æ—Ç –Ω–æ–º–µ—Ä (127, 303) –æ—á–µ–Ω—å –ø–æ—Ö–æ–∂ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π ID —ç–ª–µ–º–µ–Ω—Ç–∞. –ü–æ —Å—É—Ç–∏ —ç—Ç–æ —Ç–æ—Ç –∂–µ ID –∫–∞—Ä—Ç–æ—á–∫–∏, –ø—Ä–æ—Å—Ç–æ Bitrix –µ–≥–æ "–ø–æ–¥–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–ª" –≤ –∞–¥—Ä–µ—Å —Å–ª–∞–π–¥–µ—Ä–∞. –≠—Ç–æ—Ç ID —Ç–æ–∂–µ –º–æ–∂–Ω–æ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –¥–æ—Å—Ç–∞—Ç—å, –µ—Å–ª–∏ –æ–Ω –≤—Å–ø–ª—ã–≤–∞–µ—Ç –≤ document.referrer, –ø–æ—Ç–æ–º—É —á—Ç–æ –∏–Ω–æ–≥–¥–∞ Bitrix –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç—É–¥–∞ —Ç–∞–∫—É—é –∂–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É.

–ü–æ—ç—Ç–æ–º—É fallback 3 –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å fallback 2: –º—ã –ø—Ä–æ—Å—Ç–æ –¥–µ–ª–∞–µ–º —Ö–æ—Ä–æ—à—É—é —Ä–µ–≥—É–ª—è—Ä–∫—É –Ω–∞ document.referrer.

3. –ì–æ—Ç–æ–≤—ã–π –∫–æ–¥-—Ö–µ–ª–ø–µ—Ä resolveContext()

–í–æ—Ç —É—Ç–∏–ª–∏—Ç–∞, –∫–æ—Ç–æ—Ä—É—é —è –±—ã —Å–µ–π—á–∞—Å –¥–æ–±–∞–≤–∏–ª –≤ —Ç–≤–æ–π —Ñ—Ä–æ–Ω—Ç. –≠—Ç–æ –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –ø–æ—Å–ª–µ BX24.init –∏ –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ crm.item.get.

function extractIdFromReferrer(ref) {
  try {
    if (!ref) return null;
    const url = new URL(ref); // –º–æ–∂–µ—Ç –∫–∏–Ω—É—Ç—å –æ—à–∏–±–∫—É –µ—Å–ª–∏ ref = "" –∏–ª–∏ —Å—Ç—Ä–∞–Ω–Ω—ã–π
    const parts = url.pathname.split('/').filter(Boolean);
    // –ò–¥—ë–º —Å –∫–æ–Ω—Ü–∞ –∏ –∏—â–µ–º –ø–µ—Ä–≤–æ–µ —á–∏—Å—Ç–æ —Ü–∏—Ñ—Ä–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    for (let i = parts.length - 1; i >= 0; i--) {
      if (/^\d+$/.test(parts[i])) {
        return parts[i]; // –Ω–∞–ø—Ä–∏–º–µ—Ä "127"
      }
    }
    return null;
  } catch (e) {
    console.warn("extractIdFromReferrer: –Ω–µ —Å–º–æ–≥ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å referrer", ref, e);
    return null;
  }
}

function resolveContextWithRetries(maxAttempts, cb) {
  let attempt = 1;

  function tryOnce() {
    BX24.placement.info(function(info) {
      // 1. entityTypeId –∏–∑ placement, –∫–∞–∫ —Ä–∞–Ω—å—à–µ
      let entityTypeId = null;
      const placementName = info?.placement || '';
      const match = /^CRM_DYNAMIC_(\d+)_DETAIL_TAB$/.exec(placementName);
      if (match) {
        entityTypeId = match[1]; // "176"
      }

      // 2. –ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å ID –∏–∑ info.options
      let entityId = null;
      const opt = info?.options;
      if (opt && typeof opt === 'object') {
        if ('ID' in opt && /^\d+$/.test(opt.ID)) {
          entityId = String(opt.ID);
        } else if ('id' in opt && /^\d+$/.test(opt.id)) {
          entityId = String(opt.id);
        }
      }

      // 3. –µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç - –ø—Ä–æ–±—É–µ–º document.referrer
      if (!entityId) {
        const refGuess = extractIdFromReferrer(document.referrer);
        if (refGuess) {
          entityId = refGuess;
        }
      }

      console.log("üìã CONTEXT TRY:", {
        attempt,
        entityId: entityId || "‚ùå –ù–ï –ù–ê–ô–î–ï–ù",
        entityTypeId: entityTypeId || "‚ùå",
        placement: placementName,
        options: info?.options,
        referrer: document.referrer,
        pathname: window.location.pathname
      });

      if (entityId || attempt >= maxAttempts) {
        cb({
          entityId: entityId || null,
          entityTypeId: entityTypeId || null
        });
      } else {
        attempt++;
        setTimeout(tryOnce, 100);
      }
    });
  }

  tryOnce();
}


–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (–ø–æ—Å–ª–µ BX24.init):

BX24.init(function() {
  resolveContextWithRetries(3, function(ctx) {
    const { entityId, entityTypeId } = ctx;

    if (!entityId) {
      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º fallback —ç–∫—Ä–∞–Ω "–ù–µ –º–æ–≥—É –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID"
      renderNoContextScreen(entityTypeId);
      return;
    }

    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω
    renderMainScreen(entityTypeId, entityId);

    // –∏ —Ç—è–Ω–µ–º CRM-–¥–∞–Ω–Ω—ã–µ
    BX24.callMethod(
      "crm.item.get",
      {
        entityTypeId: Number(entityTypeId),
        id: Number(entityId)
      },
      function(res) {
        if (res.error()) {
          console.error("crm.item.get error:", res.error());
        } else {
          console.log("crm.item.get data:", res.data());
          // –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
        }
      }
    );
  });
});


–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –∫–æ–¥:

–°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å ID –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ (info.options.ID).

–ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å ‚Äî –≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é —Ü–∏—Ñ—Ä—É –∏–∑ document.referrer.

–õ–æ–≥–∏—Ä—É–µ—Ç –ø–æ–ø—ã—Ç–∫–∏ (–∫–∞–∫ —Ç—ã —É–∂–µ –¥–µ–ª–∞–µ—à—å).

–î–∞—ë—Ç —Ç–µ–±–µ entityId, –¥–∞–∂–µ –≤ —Å–ª—É—á–∞–µ –∫–æ–≥–¥–∞ Bitrix –Ω–µ –ø—Ä–æ–∫–∏–Ω—É–ª options.ID, –∞ —Ç–≤–æ–π UI –≤—Å—ë –µ—â—ë –∫–∞–∫–∏–º-—Ç–æ –æ–±—Ä–∞–∑–æ–º –Ω–∞ /install.

–¢–æ –µ—Å—Ç—å –æ–Ω –∏–º–µ–Ω–Ω–æ —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Ç–≤–æ—é –∏–¥–µ—é ‚Äú–æ–±–æ–π—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É placement –ø–æ–ª–Ω–æ—Å—Ç—å—é‚Äù.

4. –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è
4.1. Cross-origin

window.parent.location –ø–æ—á—Ç–∏ –Ω–∞–≤–µ—Ä–Ω—è–∫–∞ –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ—Ç–æ–º—É —á—Ç–æ Bitrix24 –∏ Replit ‚Äî —Ä–∞–∑–Ω—ã–µ –¥–æ–º–µ–Ω—ã. –ï—Å–ª–∏ –ø–æ–ø—ã—Ç–∞–µ—à—å—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å window.parent.location.href –∏–∑ iframe, —Å–ª–æ–≤–∏—à—å SecurityError. –¢–∞–∫ —á—Ç–æ –ª—É—á—à–µ –¥–∞–∂–µ –Ω–µ –ø—ã—Ç–∞—Ç—å—Å—è ‚Äî document.referrer —É–∂–µ –∏ –µ—Å—Ç—å —Ç–æ—Ç –ª–µ–≥–∞–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª, –∫–æ—Ç–æ—Ä—ã–π –±—Ä–∞—É–∑–µ—Ä –Ω–∞–º –¥–∞—ë—Ç –∏–∑ —Ä–æ–¥–∏—Ç–µ–ª—è.

–ò —Ç—ã —É–∂–µ –≤–∏–¥–µ–ª, —á—Ç–æ document.referrer –≤ –∫–∞–∫–∏–µ-—Ç–æ –º–æ–º–µ–Ω—Ç—ã –±—ã–ª –ø—Ä–æ—Å—Ç–æ https://mitclick.bitrix24.ru/ (–±–µ–∑ –ø—É—Ç–∏). –¢–∞–∫–æ–µ —Ç–æ–∂–µ –º–æ–∂–µ—Ç –æ—Å—Ç–∞—Ç—å—Å—è. –ü–æ—ç—Ç–æ–º—É fallback —á–µ—Ä–µ–∑ referrer –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω, –Ω–æ –æ—á–µ–Ω—å —á–∞—Å—Ç–æ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –Ω–µ –∫–∞–∫ –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω, –∞ –∫–∞–∫ —Å–∞–π–¥-—Å–ª–∞–π–¥–µ—Ä .../details/<ID>/?IFRAME=Y.

4.2. –°–∞–π–¥-—Å–ª–∞–π–¥–µ—Ä vs –ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞

–¢—ã –Ω–∞–ø–∏—Å–∞–ª:

–ï—Å–ª–∏ –≤—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É, –∑–Ω–∞—á–∏—Ç –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ side-slider —Ä–µ–∂–∏–º–µ.

–ó–¥–µ—Å—å –º–∞–ª–µ–Ω—å–∫–∞—è –ø–æ–ø—Ä–∞–≤–∫–∞: –¥–∞–∂–µ –µ—Å–ª–∏ —Ç—ã –Ω–µ –≤–∏–¥–∏—à—å –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É (Bitrix —Ç–µ–ø–µ—Ä—å –æ—á–µ–Ω—å –ª—é–±–∏—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –≤—Å—ë –≤ –≤–∏–¥–µ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏), —ç—Ç–æ –≤—Å—ë —Ä–∞–≤–Ω–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Å–∞–π–¥-—Å–ª–∞–π–¥–µ—Ä–æ–º. –ò –≤ –Ω—ë–º –∫–∞–∫ —Ä–∞–∑ —á–∞—â–µ –±—ã–≤–∞–µ—Ç, —á—Ç–æ info.options –ø—É—Å—Ç–æ–π, –∏ —Å–ø–∞—Å–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–∞—Ä—Å–∏–Ω–≥ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞. –¢–∞–∫ —á—Ç–æ –º—ã –Ω–µ –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º —ç—Ç—É –≥–∏–ø–æ—Ç–µ–∑—É ‚Äî –º—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞.

5. –ò—Ç–æ–≥–æ –ø–æ –ø–ª–∞–Ω—É

–¢–≤–æ–π –ø–ª–∞–Ω ‚Äî –∞–±—Å–æ–ª—é—Ç–Ω–æ –ª–æ–≥–∏—á–Ω—ã–π. –í–æ—Ç –∫–∞–∫ —è –±—ã –µ–≥–æ –ø–µ—Ä–µ–ø–∏—Å–∞–ª –∫–∞–∫ "–±–æ–µ–≤—É—é —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é", —á—Ç–æ–±—ã –ø—Ä—è–º–æ –≤–Ω–µ–¥—Ä–∏—Ç—å:

–ù–µ –ø–æ–ª–∞–≥–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ info.options.ID.
–≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å, –Ω–æ –Ω–µ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π.

–î–æ–±–∞–≤–∏—Ç—å fallback —á–µ—Ä–µ–∑ document.referrer.
–ü–∞—Ä—Å–∏–º –ø—É—Ç—å, –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ü–∏—Ñ—Ä—É. –≠—Ç–æ —á–∞—â–µ –≤—Å–µ–≥–æ ID —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–º–∞—Ä—Ç-–ø—Ä–æ—Ü–µ—Å—Å–∞ (127, 303, 179 –∏ —Ç.–¥.).

–î–µ–ª–∞—Ç—å 2‚Äì3 –ø–æ–ø—ã—Ç–∫–∏ —Å –ø–∞—É–∑–æ–π.
–ò–Ω–æ–≥–¥–∞ Bitrix –æ—Ç–¥–∞–µ—Ç options.ID –Ω–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ. –£ –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å retry ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º.

–ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –º–µ—Ç–æ–¥ –Ω–µ –¥–∞–ª ID ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç" —ç–∫—Ä–∞–Ω, –Ω–æ –Ω–µ –ø–∞–¥–∞—Ç—å.
–≠—Ç–æ —É–∂–µ —É —Ç–µ–±—è –µ—Å—Ç—å ("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏...").

–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å —ç—Ç–∏–º ‚Äî –¥–∞, –≤—Å—ë-—Ç–∞–∫–∏ —É–±—Ä–∞—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /install, —á—Ç–æ–±—ã –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –ø—É—Ç—å –∑–∞—Ä–∞–±–æ—Ç–∞–ª —à—Ç–∞—Ç–Ω–æ.
–ü–æ—Ç–æ–º—É —á—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –ø—É—Ç—å –≤—Å—ë —Ä–∞–≤–Ω–æ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ, —á–µ–º –∂–∏—Ç—å –Ω–∞ —Ö–∞–∫–∞—Ö.

–ò –≤–æ—Ç —ç—Ç–æ ‚Äî —É–∂–µ –ø—Ä–æ–¥–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏.