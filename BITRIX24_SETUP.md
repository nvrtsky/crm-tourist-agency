# Инструкция по интеграции с Битрикс24

Это приложение интегрируется с Битрикс24 как встраиваемое приложение во вкладке смарт-процесса "Событие".

## Архитектура интеграции

- **Frontend**: React SPA с Bitrix24 JS SDK для получения контекста элемента смарт-процесса
- **Backend**: Express API для синхронизации данных с Bitrix24 CRM через REST API
- **Данные**: 
  - Туристы → Контакты в CRM Битрикс24
  - Маршруты → Локальное хранилище + пользовательские поля элемента смарт-процесса

## Шаг 1: Создание локального приложения в Битрикс24

1. Перейдите в **Приложения** → **Разработчикам** → **Другое** → **Локальное приложение**
2. Создайте новое приложение с названием "Управление групповыми турами"
3. Настройки приложения:
   - **URL установки**: `https://your-replit-app.replit.app/`
   - **URL страницы настроек**: оставьте пустым
   - **Права**: 
     - `crm` - Доступ к CRM
     - Дополнительные разрешения для работы с контактами и элементами смарт-процессов

## Шаг 2: Настройка placement (размещения)

1. В настройках приложения добавьте placement для смарт-процесса:
   - **Код размещения**: `CRM_DYNAMIC_{ENTITY_TYPE_ID}_DETAIL_TAB` (замените {ENTITY_TYPE_ID} на ID вашего смарт-процесса "Событие")
   - **Обработчик**: URL вашего приложения на Replit
   - **Название вкладки**: "Управление группами"

**Как узнать ENTITY_TYPE_ID смарт-процесса:**
1. Откройте любой элемент смарт-процесса "Событие"
2. В URL браузера найдите параметр `typeId` или `entityTypeId`
3. Альтернативно: используйте REST API метод `crm.type.list` для получения списка смарт-процессов

## Шаг 3: Получение Webhook URL

1. В портале Битрикс24 перейдите в **Настройки** → **Настройки портала** → **Вебхуки**
2. Создайте новый входящий вебхук с правами:
   - `crm` - Доступ к CRM
3. Скопируйте URL вебхука (формат: `https://ваш-портал.bitrix24.ru/rest/1/webhook_key/`)

## Шаг 4: Настройка пользовательских полей элемента смарт-процесса (опционально)

Для хранения сводной информации о туре в элементе смарт-процесса создайте пользовательские поля:

1. Перейдите в **CRM** → **Настройки** → Найдите ваш смарт-процесс "Событие" → **Настройка полей**
2. Создайте поля:
   - `UF_CRM_TOUR_ROUTE` (Строка/Текст) - для хранения данных маршрута в JSON

## Шаг 5: Настройка переменных окружения в Replit

В Secrets вашего Replit проекта добавьте:

```
BITRIX24_WEBHOOK_URL=https://ваш-портал.bitrix24.ru/rest/1/ваш-webhook-key/
```

Опционально (если используете пользовательские поля):
```
UF_CRM_TOUR_ROUTE=UF_CRM_XXXXX
```

## Шаг 6: Публикация приложения

1. Опубликуйте ваш Replit проект
2. Скопируйте URL опубликованного приложения
3. Обновите URL в настройках локального приложения Битрикс24

## Использование

### В режиме разработки (без Битрикс24)

Приложение работает в standalone режиме с mock данными:
- Entity ID: `dev-entity-123`
- Entity Type ID: `dev-type-1`
- Access Token: `dev-token` (mock)
- Bitrix24 REST API интеграция отключена (используется только backend webhook)

**Важно**: В режиме разработки клиентские вызовы Bitrix24 REST API не работают, но backend API через webhook функционирует при наличии BITRIX24_WEBHOOK_URL.

### В режиме production (внутри Битрикс24)

1. Откройте любой элемент смарт-процесса "Событие"
2. Перейдите на вкладку "Управление группами"
3. Приложение загрузится и получит через BX24.getAuth():
   - `access_token` - для клиентских REST API вызовов
   - `expires_in` - время жизни токена
   - `member_id` - ID участника портала
   - `domain` - домен портала
4. Через BX24.placement.info() получит:
   - `options.ID` - ID текущего элемента смарт-процесса
   - `options.ENTITY_TYPE_ID` - ID типа смарт-процесса

## Функциональность

### Создание туриста
При добавлении туриста:
1. Создается контакт в CRM Битрикс24
2. Контакт привязывается к текущему элементу смарт-процесса
3. Данные сохраняются в локальное хранилище
4. Обновляются пользовательские поля элемента (если настроены)

### Редактирование туриста
- Обновляется контакт в CRM
- Обновляются данные в локальном хранилище

### Удаление туриста
- Удаляется контакт из CRM (опционально)
- Удаляются данные из локального хранилища

## Структура данных

### Турист (Tourist)
```typescript
{
  id: string;
  entityId: string;            // ID элемента смарт-процесса
  entityTypeId: string;        // ID типа смарт-процесса
  bitrixContactId: string;     // ID контакта в CRM
  name: string;
  email?: string;
  phone?: string;
}
```

### Посещение города (CityVisit)
```typescript
{
  id: string;
  touristId: string;
  city: 'Beijing' | 'Luoyang' | 'Xian' | 'Zhangjiajie';
  arrivalDate: string;         // ISO date
  transportType: 'train' | 'plane';
  hotelName: string;
}
```

## Безопасность и аутентификация

### Backend API (server-to-server)
- Использует входящий webhook URL (BITRIX24_WEBHOOK_URL)
- Хранится в Secrets Replit
- Используется для создания/обновления контактов и работы с элементами смарт-процессов через `crm.item.*` методы

### Frontend (клиент-сервер, если требуется)
- Access token получается через BX24.getAuth()
- Автоматически обновляется Bitrix24 SDK
- Доступен через useBitrix24 хук: `const { accessToken } = useBitrix24()`
- Используется для прямых REST API вызовов из браузера (если необходимо)

### Валидация данных
- Все входящие данные проходят валидацию через Zod схемы
- Невалидные запросы отклоняются с кодом 400
- Обязательные поля: entityId, entityTypeId, name для туристов; все поля для city visits

## REST API методы для смарт-процессов

Приложение использует следующие методы для работы со смарт-процессами:

- `crm.item.get` - получение элемента смарт-процесса
- `crm.item.update` - обновление элемента смарт-процесса
- `crm.item.contact.add` - привязка контакта к элементу
- `crm.contact.add` - создание контакта
- `crm.contact.update` - обновление контакта
- `crm.contact.delete` - удаление контакта

## Поддержка

При возникновении проблем проверьте:
1. Корректность webhook URL в Secrets
2. Права приложения в Битрикс24
3. Правильность ENTITY_TYPE_ID в placement
4. Логи в консоли браузера и на сервере
