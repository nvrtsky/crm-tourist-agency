нажимать на номер каждый раз не нужно. Это поведение появляется, когда iFrame открыт без явного указания активного диалога. Автоматизация делается на стороне генерации iFrame.

Ниже — точное объяснение и готовый алгоритм.

Почему сейчас требуется клик по номеру

По скриншоту видно левую колонку «Чаты по каналам» и список бизнес-номеров.
Это означает, что Wazzup получил контекст карточки, но не получил команду “какой диалог открыть сразу”.

В таком режиме iFrame:

показывает список доступных диалогов,

ждёт ручного выбора,

не открывает чат автоматически.

Как сделать автo-открытие диалога (правильный способ)
Ключевой принцип

Если filter и activeChat совпадают и содержат корректный channelId, Wazzup сам открывает диалог, без кликов.

Минимально правильный payload iFrame

У вас обязательно должно быть:

{
  "scope": "card",
  "user": {
    "id": "CRM_USER_ID",
    "name": "CRM User"
  },
  "filter": [
    {
      "chatType": "whatsapp",
      "chatId": "79257854600"
    }
  ],
  "activeChat": {
    "chatType": "whatsapp",
    "chatId": "79257854600",
    "channelId": "fd35d81d-2de9-4c4f-bc46-39402419a94b"
  },
  "options": {
    "useMessageEvents": true,
    "useDealsEvents": true
  }
}

Что здесь важно:

filter — один элемент, ровно тот же chatId

activeChat:

тот же chatId

обязательно channelId (из webhook / сохранённый)

scope = "card"

➡️ В этом случае iFrame открывается сразу в нужном диалоге, без левой “выборки”.

Почему у вас сейчас не срабатывает авто-открытие

На практике это всегда одна из причин:

1. activeChat.channelId отсутствует или null

Даже если chatId верный — без channelId Wazzup не может выбрать конкретный диалог.

2. filter содержит несколько чатов

Если filter.length > 1, Wazzup не автo-выбирает.

3. filter.chatId !== activeChat.chatId

Даже различие в формате (+7… vs 79…) ломает автo-открытие.

Рекомендованная логика в CRM (у вас почти готово)

У вас уже есть lead.wazzupChannelId, значит делаем так:

const chatId = normalizePhone(lead.phone);
const channelId =
  lead.wazzupChannelId ?? settings.defaultWhatsappChannelId;

iframePayload = {
  scope: "card",
  filter: [{ chatType: "whatsapp", chatId }],
  activeChat: { chatType: "whatsapp", chatId, channelId }
};


Никакой UI-логики в браузере не нужно — всё решается сервером.

Когда клик по номеру всё равно будет нужен (нормально)

Это допустимо только в двух случаях:

У клиента несколько диалогов с разными бизнес-номерами
→ тогда выбор канала действительно осознанный.

У лида ещё не было сообщений, и channelId неизвестен
→ тогда пользователь выбирает, с какого номера начать диалог
(после первого сообщения channelId сохранится, и дальше будет автo-открытие).

Итог

Да, это полностью автоматизируется.
Нажатие на номер — не “фича”, а признак неполного payload iFrame.

Если:

scope = card

filter = один чат

activeChat = тот же chatId + правильный channelId

➡️ Диалог открывается сразу, без кликов, всегда.