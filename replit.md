# Standalone CRM System for Tourist Agency

## Overview
This project is a standalone CRM web application designed for tourist agencies, centralizing lead, event, contact, and deal management. Its primary purpose is to streamline the CRM workflow from lead capture to group organization and itinerary tracking, serving as a comprehensive platform for managing tourist agency operations. The business vision is to provide a robust, all-in-one solution that enhances efficiency and customer engagement in the tourism sector.

## User Preferences
I prefer detailed explanations.
I want iterative development.
Ask before making major changes.

## System Architecture

### CRM Workflow
The system employs a lead-first, deal-centric, and event-based CRM flow, progressing from lead capture and qualification, conversion to contacts and deals, event assignment, to detailed event and group management.

### UI/UX Design
The frontend uses React, TypeScript, Wouter, TanStack Query, Shadcn UI, and Tailwind CSS. It features a consistent design with Shadcn components, color-coded status indicators, responsive layouts, and accessibility. Brand logos adapt to theme changes, and text colors are optimized for readability.

### Backend Architecture
The backend is built with Express.js, TypeScript, and Drizzle ORM, interacting with a PostgreSQL database. It exposes RESTful APIs for core CRM entities, uses Zod for data validation, and includes a storage layer for database abstraction.

### Database Schema
A normalized PostgreSQL database schema includes core CRM tables (`events`, `contacts`, `deals`, `leads`, `groups`), `leadTourists` for detailed tourist data, `users` for authentication, and supporting tables for `cityVisits`, `leadStatusHistory`, `notifications`, `forms`, and `formSubmissions`.

### Key Features
-   **Events Module**: Manages tourist events with filtering, sorting, color-coded availability, and participant tracking. Features comprehensive event editing with **Country and Tour Type Select fields** using recommended values while maintaining full backward compatibility with legacy data, guide assignment, and enhanced data validation. The `EventSummary` page offers inline editable itinerary details and Excel export with full responsive design (768px breakpoint). **Country Select**: Offers "Китай" and "Марокко" as recommended options, with dynamic inclusion of legacy values. **Tour Type Select**: Provides 4 predefined types (Групповой, Индивидуальный, Экскурсия, Трансфер) with automatic Russian translation via getTourTypeLabel() function. Legacy values outside the predefined list are dynamically included with "(существующее значение)" suffix for seamless editing. **EventCard Display**: Tour type is visually displayed as a secondary Badge next to event names for quick identification. **Desktop (≥768px)**: The participant table uses optimized column layout: № (sticky) | ФИО (sticky) | Данные туриста | Лид | City columns (3 per city: Прибытие, Отель, Отъезд), with only the first two columns remaining sticky for better horizontal scrolling. **Mobile (<768px)**: Card-based layout with expandable Accordion per city. **Family consolidation**: Families (leadId groups with >1 member) display as ONE consolidated card instead of individual cards per member. Card header shows "Семья (N чел.)" clickable label instead of individual names, opening a Popover listing all family members with names (Latin/Russian), tourist type badges (adult/child), primary tourist indicators, and individual edit buttons per member. Mini-groups retain separate cards since only hotel is shared. Two-pass filtering algorithm ensures the primary member (`isPrimary` flag) is selected as the family representative for card data and shared visits. The ФИО column displays Latin passport names (`foreignPassportName`) with fallback to Russian names (`contact.name`) when Latin names are unavailable. Each city has three columns: **Прибытие** (arrival: 3 paired rows - Date+Time, Transport Icons+Flight Number, Airport/Station+Transfer), **Отель** (hotel name, room type), and **Отъезд** (departure: 3 paired rows - Date+Time, Transport Icons+Flight Number, Airport/Station+Transfer). Transport type selection uses icon-based toggle buttons (Plane/Train icons) with optimistic UI updates for instant responsiveness. The `transportType` field is optional (nullable) in the database schema, allowing users to deselect transport when details are unknown. Mobile cards display visual "Общее" (shared) badges for family/mini-group shared fields, with per-section visit sourcing logic ensuring families share all arrival/hotel/departure data while mini-groups share only hotel data. All edits on mobile propagate correctly via backend fan-out to group members.
-   **Event Archive System**: Events can be manually archived/unarchived (admin only) via EditEventDialog, with automatic archiving the day after tour end date. Archive toggle in Events page filters archived tours, which display an "Архив" badge. Copy button duplicates events with "(копия)" suffix and reminder toast. Delete button requires confirmation dialog with participant count warning (admin only). Event editing restricted to admin/manager roles, while archive and delete operations require admin role.
-   **Participant Tourist Editing**: Allows direct editing of tourist data from the EventSummary page, with bidirectional sync between `leadTourists` and `contacts` tables. Includes visual tourist type indicators (adult, child, primary) and data completeness indicators. The participant table implements smart column merging for families and mini-groups, with lead status column positioned after tourist data for improved visual organization. Excel export mirrors the UI column structure and uses the same Latin/Russian name display logic. **File Upload System**: Tourist forms support passport scan uploads (`passportScans` field) stored in Replit Object Storage with preview, download, and delete capabilities. Guide comments (`guideComment` field) allow adding special notes for tour guides. **Role-based field visibility**: Users with "viewer" role (guides) see only essential fields in tourist edit forms: phone, foreign passport name (Latin), foreign passport number, passport scans, tourist type, and guide comment - all other fields are hidden for privacy and simplicity. **Birthday Indicators**: Tourists with birthdays during the tour period are visually highlighted with pink background (both desktop table rows and mobile cards) and a cake icon for quick identification.
-   **Leads Module**: Offers comprehensive lead management with dual table/Kanban views. Features automatic lead conversion upon tour assignment, lead postponement with automated follow-up, and advanced filtering. **Search functionality**: Instant case-insensitive search across firstName, lastName, middleName, email, and phone fields with dedicated search input and Search icon. Search works in combination with other filters (status, source, category, tour, color, date range) using AND logic. The unified "Сбросить" (Reset) button appears when any filter (including search) is active and clears all filters simultaneously. Supports manual and automatic color tagging based on lead status. **Lead Sorting**: Backend returns leads sorted by creation date (newest first) via ORDER BY createdAt DESC. Frontend table view maintains this sorting (newest leads at top). Kanban view uses conditional sorting: "Новый" column sorted by createdAt DESC (newest first), all other columns sorted by updatedAt DESC (recently moved leads on top). Array cloning prevents react-query cache mutation. The tourist list within lead dialogs displays Latin passport names (`foreignPassportName`) with fallback to Russian names for consistent naming across the system.
-   **Group Management**: Supports both "Families" (shared hotel/transport/invoice) and "Mini-groups" (shared hotel only), with automatic creation for families and manual creation for mini-groups.
-   **Notification System**: Provides automated in-app notifications for bookings, group capacity, upcoming events, and participant birthdays.
-   **Forms Module**: A lead generation system with a form builder, public form pages, and submission tracking, automatically creating leads from submissions.
-   **Booking Module**: A public-facing tour reservation system allowing customers to view, filter, and book tours, automatically creating leads linked to specific events.
-   **Color Indication System**: Allows manual color tagging (red, blue, green, yellow, purple) for events and leads for visual organization, with automatic status-based highlighting for leads that defers to manual tags.
-   **Authentication & User Management**: Implements session-based authentication using Passport.js with bcrypt hashing and role-based access control (admin/manager/viewer). Features include a secure login, protected routes, user management UI, and role-specific content restrictions. **Navigation Access Control**: Viewers see only "Туры" (Events), managers see only "Лиды" (Leads) and "Туры" (Events), and admins see all navigation sections (Leads, Events, Booking, Forms, Settings). The app-sidebar.tsx implements role-based menu filtering at the component level. **Lead Access Control**: Managers can be assigned to leads via the `assignedUserId` field and see only their assigned leads in the Leads module, while admins and viewers see all leads. The `/api/leads` endpoint implements server-side filtering based on user role for security and performance. **Events Page Access Control**: Viewers (guides) have read-only access to Events page with restricted UI - they cannot see statistics cards (Всего туров, Предстоящие, Почти заполнены), "Создать тур" button, or management buttons (edit/copy/delete) on EventCard. The `canManageEvents` flag (`!isAuthLoading && (role === admin || manager)`) prevents UI flash during auth loading and conditionally passes handlers to EventCard only for admin/manager roles. Backend enforces role checks on all event mutation endpoints (POST, PATCH for create/edit/archive/unarchive). **Tourist Edit Permissions**: On the EventSummary page, managers can edit only tourists from their assigned leads (participant.lead.assignedUserId must match user.id). Edit buttons are conditionally hidden for unauthorized tourists across all views (desktop table, mobile cards, family popovers, mini-group lists). Backend security enforced via PATCH /api/contacts/:id/details which validates lead assignment before allowing updates. Admins and viewers can edit all tourists without restrictions. **Delete Permissions**: ALL delete operations across the entire system are restricted to admin role only. Frontend delete buttons are conditionally rendered with isAdmin checks (Leads.tsx, Settings.tsx, EventCard.tsx, EditEventDialog.tsx). Backend DELETE endpoints use requireAdmin middleware for: events, contacts, deals, city visits, notifications, leads, tourists, groups, and group members. This ensures critical data protection and prevents accidental deletion by managers and viewers.

### Technical Decisions
Key decisions include dynamic geography for event city tracking, a standalone system design (no external CRM integrations), backend-automated notification strategy, and a refined lead data separation architecture. Includes robust features for auto-creating initial tourist entries and comprehensive tourist data completeness indicators.

## External Dependencies
-   **Frontend**: React, TypeScript, Wouter, TanStack Query, Shadcn UI, Tailwind CSS
-   **Backend**: Express.js, TypeScript, Drizzle ORM, Passport.js, bcrypt
-   **Database**: PostgreSQL (Neon-hosted)
-   **Utilities**: xlsx (Excel generation), date-fns (date manipulation), zod (schema validation)
-   **Session Management**: express-session with MemoryStore (development), rate limiting