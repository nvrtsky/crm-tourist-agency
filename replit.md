# Веб-сервис для туристического агенства

Система управления групповыми турами с интеграцией в Битрикс24.

## Описание проекта

Веб-приложение для управления групповыми турами по 4 городам Китая:
- Пекин (Beijing / 北京)
- Лоян (Luoyang / 洛阳)
- Сиань (Xi'an / 西安)
- Чжанцзяцзе (Zhangjiajie / 张家界)

Туристы могут присоединяться/отсоединяться на любом этапе маршрута.

## Интеграция с Битрикс24

Приложение работает как встраиваемая вкладка в карточке сделки Битрикс24:
- **Одна сделка = один групповой тур**
- Туристы создаются как контакты в CRM и привязываются к сделке
- Информация о маршрутах хранится в пользовательских полях сделки

Подробная инструкция по настройке: [BITRIX24_SETUP.md](./BITRIX24_SETUP.md)

## Технический стек

### Frontend
- React + TypeScript
- Wouter (роутинг)
- TanStack Query (управление состоянием API)
- Shadcn UI + Tailwind CSS
- Bitrix24 JS SDK

### Backend
- Express.js + TypeScript
- In-memory storage (MemStorage)
- Bitrix24 REST API интеграция

## Основные функции

### Управление туристами
- ✅ Создание туриста (+ контакт в CRM)
- ✅ Редактирование данных туриста
- ✅ Удаление туриста
- ✅ Привязка к сделке Битрикс24

### Маршруты
- ✅ Выбор городов из списка
- ✅ Указание даты прибытия в каждый город
- ✅ Выбор транспорта (самолет/поезд)
- ✅ Фиксация отеля в каждом городе

### Dashboard
- ✅ Статистика по туристам
- ✅ Распределение по городам
- ✅ Предстоящие прибытия
- ✅ Количество используемых отелей

## Структура проекта

```
├── client/               # Frontend React приложение
│   ├── src/
│   │   ├── components/  # Переиспользуемые компоненты
│   │   ├── hooks/       # Custom hooks (useBitrix24)
│   │   ├── pages/       # Страницы приложения
│   │   └── lib/         # Утилиты
├── server/              # Backend Express сервер
│   ├── bitrix24.ts     # Bitrix24 API клиент
│   ├── routes.ts       # API роуты
│   └── storage.ts      # Хранилище данных
├── shared/             # Общие типы и схемы
│   └── schema.ts       # TypeScript типы и Zod схемы
└── attached_assets/    # Изображения городов
```

## Переменные окружения

### Обязательные (для production)
```env
BITRIX24_WEBHOOK_URL=https://your-portal.bitrix24.ru/rest/1/your-key/
```

### Опциональные
```env
UF_CRM_TOUR_ROUTE=UF_CRM_XXXXX  # Код пользовательского поля для маршрута
SESSION_SECRET=your-session-secret
```

## Режимы работы

### Development (без Bitrix24)
Приложение работает standalone с mock данными:
- Deal ID: `dev-deal-123`
- Bitrix24 интеграция отключена
- Полный функционал для разработки и тестирования

### Production (в Bitrix24)
Приложение получает контекст через Bitrix24 JS SDK:
- Автоматическое получение Deal ID
- Синхронизация контактов с CRM
- Сохранение данных в пользовательские поля сделки

## API Endpoints

### Туристы
- `GET /api/tourists/:dealId` - Получить туристов сделки
- `POST /api/tourists` - Создать туриста
- `PATCH /api/tourists/:id` - Обновить туриста
- `DELETE /api/tourists/:id` - Удалить туриста

## Последние изменения

### 2025-10-24
- ✅ Интегрирован Bitrix24 JS SDK
- ✅ Создан Bitrix24 REST API клиент
- ✅ Обновлена схема данных (добавлены dealId и bitrixContactId)
- ✅ Реализована синхронизация туристов с контактами CRM
- ✅ Адаптирован UI для работы в iframe (без sidebar)
- ✅ Создана документация по настройке интеграции

## Разработка

```bash
npm run dev  # Запуск dev сервера (http://localhost:5000)
```

## Deployment

Приложение готово к публикации на Replit:
1. Добавьте BITRIX24_WEBHOOK_URL в Secrets
2. Опубликуйте проект
3. Настройте локальное приложение в Битрикс24
4. Добавьте placement на вкладку сделки
